{% extends "base.html" %}

{% block title %}Mood Journal ‚Ä¢ Demo{% endblock %}

{% block extra_head %}
<style>
  @keyframes float {
    0%   { transform: translateY(0) rotate(0) }
    50%  { transform: translateY(-10px) rotate(5deg) }
    100% { transform: translateY(0) rotate(0) }
  }
  .float-animation {
    animation: float 4s ease-in-out infinite;
  }
</style>
{% endblock %}

{% block content %}
<!-- Title -->
<div class="mb-8 flex items-center justify-between">
  <div class="flex items-center gap-4">
    <div
      class="p-3 rounded-xl text-white float-animation
             bg-[linear-gradient(to_bottom_right,rgb(var(--mj-accent)),rgb(var(--mj-accent-soft)))]">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div>
      <h2 class="text-3xl font-bold text-gray-900">Mood Journal</h2>
      <p class="text-sm text-slate-500">Track how you feel, day by day.</p>
    </div>
  </div>

  <!-- Quick links to special views -->
  <div class="hidden sm:flex items-center gap-2">
    <a href="{{ url_for('calendar_view') }}"
       class="text-xs sm:text-sm px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">
      üìÖ Timeline
    </a>
    <a href="{{ url_for('mood_graph') }}?mode=line"
       class="text-xs sm:text-sm px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">
      üìà Mood Graph
    </a>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-8">
  <!-- Left: Streak + Actions + Calendar / Graph summaries -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <!-- Streak + actions -->
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-2">
        <span class="text-xl">üî•</span>
        <h3 class="text-lg font-semibold text-gray-900">Streak</h3>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <a href="{{ url_for('weekly_report') }}"
           class="rounded-lg px-3 py-2 text-xs sm:text-sm bg-slate-100 text-slate-900 hover:bg-slate-200">
          Weekly
        </a>
        <a href="{{ url_for('monthly_report') }}"
           class="rounded-lg px-3 py-2 text-xs sm:text-sm bg-slate-100 text-slate-900 hover:bg-slate-200">
          Monthly
        </a>
        <button onclick="openModal('addModal')"
                class="rounded-lg px-3 py-2 text-xs sm:text-sm text-white
                       bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
          + Add Entry
        </button>
      </div>
    </div>

    {% if summary is defined %}
    <div class="grid grid-cols-3 gap-4 text-center mt-6">
      <div class="rounded-xl p-4 bg-slate-50">
        <div class="text-xs uppercase tracking-wide text-slate-500">Current</div>
        <div class="text-2xl font-bold mt-1">{{ summary.current }}</div>
      </div>
      <div class="rounded-xl p-4 bg-slate-50">
        <div class="text-xs uppercase tracking-wide text-slate-500">Longest</div>
        <div class="text-2xl font-bold mt-1">{{ summary.longest }}</div>
      </div>
      <div class="rounded-xl p-4 bg-slate-50">
        <div class="text-xs uppercase tracking-wide text-slate-500">Last Entry</div>
        <div class="text-sm font-medium mt-1">{{ summary.last or "‚Äî" }}</div>
      </div>
    </div>
    {% endif %}

    <!-- Calendar / timeline stub -->
    {% if calendar is defined %}
    <div class="mt-6">
      <h4 class="text-sm font-semibold mb-2">Timeline (month view)</h4>
      <p class="text-xs text-slate-500 mb-2">Dates with entries in the current month.</p>
      <div class="text-xs text-slate-600 max-h-40 overflow-y-auto border rounded-lg p-2 bg-slate-50">
        {% for d, entries_for_day in calendar.items() %}
        <div class="flex justify-between border-b last:border-0 py-1">
          <span>{{ d }}</span>
          <span>{{ entries_for_day|length }} entr{{ 'ies' if entries_for_day|length != 1 else 'y' }}</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Mood graph summary (line or bar) -->
    {% if mood_graph_labels is defined and mood_graph_values is defined %}
    <div class="mt-6">
      <div class="flex items-center justify-between mb-2">
        <h4 class="text-sm font-semibold">
          Mood graph
          {% if mood_graph_mode == 'bar' %}<span class="text-[11px] text-slate-500">(Frequency)</span>{% else %}
          <span class="text-[11px] text-slate-500">(Average per day)</span>
          {% endif %}
        </h4>
        <div class="flex items-center gap-1 text-[11px] text-slate-500">
          <a href="{{ url_for('mood_graph') }}?mode=line"
             class="px-2 py-1 rounded-md border border-slate-200 {{ 'bg-slate-100' if mood_graph_mode == 'line' }}">
            Line
          </a>
          <a href="{{ url_for('mood_graph') }}?mode=bar"
             class="px-2 py-1 rounded-md border border-slate-200 {{ 'bg-slate-100' if mood_graph_mode == 'bar' }}">
            Bar
          </a>
        </div>
      </div>
      <canvas id="moodChart" class="w-full h-40"></canvas>
    </div>
    {% endif %}
  </div>

  <!-- Right: Entries list -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-2">
        <span class="text-xl">üåô</span>
        <h3 class="text-lg font-semibold text-gray-900">Your Entries</h3>
      </div>
      {% if entries %}
        <span class="text-sm text-gray-500">
          {{ entries|length }} entr{{ 'ies' if entries|length != 1 else 'y' }}
        </span>
      {% endif %}
    </div>

    {% if entries %}
    <div class="space-y-3 max-h-[28rem] overflow-y-auto pr-1">
      {% for e in entries %}
      <div class="group relative p-4 rounded-xl border bg-white hover:shadow-md transition-all duration-200">
        <div class="flex items-start justify-between mb-2">
          <div class="flex items-start gap-3">
            <div class="text-2xl leading-none" title="Ranking">
              {{ ranking_emoji(e.ranking) }}
            </div>
            <div>
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-900">{{ e.entry_name }}</span>
                {% if e.is_private_check() %}
                  <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 text-[11px] font-semibold px-2 py-0.5">
                    üîí Private
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 text-[11px] font-semibold px-2 py-0.5">
                    üåê Public
                  </span>
                {% endif %}
              </div>
              <p class="text-xs text-gray-500">
                {{ e.entry_date.isoformat() }} ‚Ä¢ Mood {{ e.mood_rating }}
              </p>

              {% set bios = e.get_biometrics() if e.get_biometrics else {} %}
              {% if bios %}
              <div class="mt-2 flex flex-wrap gap-2">
                {% for k, v in bios.items() %}
                  <span class="text-xs bg-amber-50 text-amber-800 border border-amber-200 rounded-full px-2 py-0.5">
                    {{ k }}: {{ v }}
                  </span>
                {% endfor %}
              </div>
              {% endif %}

              {% if e.tags %}
              <div class="mt-2 flex flex-wrap gap-2">
                {% for t in e.tags %}
                  <span class="text-xs bg-slate-100 text-slate-700 rounded-full px-2 py-0.5">
                    #{{ t }}
                  </span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          <div class="text-xs text-gray-400">{{ ranking_emoji(e.ranking) }} {{ e.ranking }}</div>
        </div>

        <div class="flex items-center gap-2">
          <a href="{{ url_for('view_entry', entry_id=e.entry_id_str) }}"
             class="rounded-lg px-3 py-1.5 text-sm text-white
                    bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
            View
          </a>

          <a href="{{ url_for('edit_entry_open', entry_id=e.entry_id_str) }}"
             class="rounded-lg px-3 py-1.5 text-sm text-white
                    bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
            Edit
          </a>

          <form method="post" action="{{ url_for('delete_entry', entry_id=e.entry_id_str) }}"
                onsubmit="return confirm('Delete this entry?');">
            <button class="rounded-lg px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200">
              Delete
            </button>
          </form>

          {% if not e.is_private_check() %}
          <form method="post" action="{{ url_for('make_private', entry_id=e.entry_id_str) }}" class="ml-auto">
            {% if not password_set %}
              <button class="text-[13px] text-[rgb(var(--mj-accent))] hover:underline">
                Make Private (set password)
              </button>
            {% else %}
              <button class="text-[13px] text-[rgb(var(--mj-accent))] hover:underline">
                Make Private
              </button>
            {% endif %}
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-100 rounded-full mb-4">
        <span class="text-2xl">‚òÅÔ∏è</span>
      </div>
      <p class="text-gray-500">No entries yet. Click ‚ÄúAdd Entry‚Äù.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Entry Modal -->
<div id="addModal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40" onclick="closeModal('addModal')"></div>
  <div class="relative max-w-xl mx-auto mt-16 w-[92%]">
    <div class="bg-white rounded-2xl shadow-xl max-h-[85vh] flex flex-col">
      <!-- Header -->
      <div class="px-6 pt-6 pb-4 flex items-start justify-between">
        <h3 class="text-lg font-semibold">Add Entry</h3>
        <button class="text-slate-400 hover:text-slate-600" onclick="closeModal('addModal')">‚úï</button>
      </div>

      <!-- Body -->
      <div class="px-6 pb-4 overflow-y-auto">
        <form id="addForm" method="POST" action="{{ url_for('add_entry') }}" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input name="title" class="w-full rounded-xl border px-3 py-2" required />
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-sm block mb-1">Year</label>
              <input name="year" type="number" class="w-full rounded-xl border px-3 py-2"
                     value="{{ today.year }}" required />
            </div>
            <div>
              <label class="text-sm block mb-1">Month</label>
              <input name="month" type="number" class="w-full rounded-xl border px-3 py-2"
                     value="{{ today.month }}" required />
            </div>
            <div>
              <label class="text-sm block mb-1">Day</label>
              <input name="day" type="number" class="w-full rounded-xl border px-3 py-2"
                     value="{{ today.day }}" required />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ranking (1‚Äì8)</label>
            <div class="grid grid-cols-4 gap-2">
              {% for r in range(1,9) %}
              <label
                class="cursor-pointer flex items-center justify-center gap-2 rounded-xl border px-3 py-2 hover:bg-slate-50">
                <input type="radio" name="ranking" value="{{ r }}" {% if r==5 %}checked{% endif %} class="mr-2">
                <span class="text-lg">{{ ranking_emoji(r) }}</span>
                <span class="text-sm text-slate-700">{{ r }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mood rating (1‚Äì100)</label>
            <input name="mood_rating" type="number" min="1" max="100"
                   class="w-full rounded-xl border px-3 py-2" placeholder="50" />
            <p class="text-xs text-slate-500 mt-1">
              1 = terrible, 100 = fantastic.
            </p>
          </div>

          <!-- Biometrics (Add) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Biometrics (optional)</label>
            <div class="grid sm:grid-cols-2 gap-3">
              {% for key, choices in BIOMETRICS.items() %}
              <div>
                <label class="text-xs text-slate-500 block mb-1">{{ key }}</label>
                <select name="bio_{{ key }}" class="w-full rounded-xl border px-3 py-2">
                  <option value="">‚Äî</option>
                  {% for v in choices %}
                    <option value="{{ v }}">{{ v|title }}</option>
                  {% endfor %}
                </select>
              </div>
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="text-sm block mb-1">Tags (comma-separated)</label>
            <input name="tags" class="w-full rounded-xl border px-3 py-2"
                   placeholder="work, gym, study" />
          </div>

          <div>
            <label class="text-sm block mb-1">Body</label>
            <textarea name="body" rows="6" class="w-full rounded-xl border px-3 py-2"
                      placeholder="How was your day?"></textarea>
          </div>
        </form>
      </div>

      <!-- Sticky footer -->
      <div class="px-6 py-4 border-t bg-white sticky bottom-0 rounded-b-2xl flex items-center justify-end gap-3">
        <button type="button" onclick="closeModal('addModal')"
                class="rounded-xl px-4 py-2 bg-slate-100 hover:bg-slate-200">
          Cancel
        </button>
        <button type="submit" form="addForm"
                class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
          Create
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Entry Modal -->
{% if view_e is defined %}
<div id="viewModal" class="fixed inset-0 z-50 {% if not open_view_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/40" onclick="closeModal('viewModal')"></div>
  <div class="relative max-w-2xl mx-auto mt-12 w-[92%]">
    <div class="bg-white rounded-2xl shadow-xl max-h-[85vh] overflow-hidden flex flex-col">
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">{{ view_e.entry_name }}</h3>
          <p class="text-sm text-slate-500">{{ view_e.entry_date.isoformat() }}</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600" onclick="closeModal('viewModal')">‚úï</button>
      </div>

      <div class="px-6 pb-4 space-y-3">
        <div class="text-slate-600 flex flex-wrap items-center gap-4">
          <div>
            <span class="text-sm">Ranking:</span>
            <span class="font-semibold">{{ ranking_emoji(view_e.ranking) }} {{ view_e.ranking }}</span>
          </div>
          <div>
            <span class="text-sm">Mood rating:</span>
            <span class="font-semibold">{{ view_e.mood_rating }}</span>
          </div>
          {% if view_e.is_private_check() %}
            <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 text-[11px] font-semibold px-2 py-0.5">
              üîí Private
            </span>
          {% else %}
            <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 text-[11px] font-semibold px-2 py-0.5">
              üåê Public
            </span>
          {% endif %}
        </div>

        {% set bios = view_e.get_biometrics() if view_e.get_biometrics else {} %}
        {% if bios %}
        <div class="flex flex-wrap gap-2">
          {% for k, v in bios.items() %}
          <span class="text-xs bg-amber-50 text-amber-800 border border-amber-200 rounded-full px-2 py-0.5">
            {{ k }}: {{ v }}
          </span>
          {% endfor %}
        </div>
        {% endif %}

        {% if view_e.tags %}
        <div class="flex flex-wrap gap-2">
          {% for t in view_e.tags %}
          <span class="text-xs bg-slate-100 text-slate-700 rounded-full px-2 py-1">
            #{{ t }}
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <div class="px-6 pb-6 overflow-y-auto">
        {% if view_body is not none %}
          <div class="prose max-w-none whitespace-pre-wrap">{{ view_body|safe }}</div>
        {% else %}
          {% if view_e.is_private_check() %}
            {% if view_ask_password %}
            <form method="post" action="{{ url_for('unlock_entry', entry_id=view_e.entry_id_str) }}" class="space-y-3 max-w-sm">
              <p class="text-sm text-slate-600">This entry is private. Enter the password to view.</p>
              <input name="password" type="password" class="w-full rounded-xl border px-3 py-2"
                     placeholder="Password" required />
              <button
                class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
                Unlock
              </button>
            </form>
            {% else %}
              <div class="text-slate-500 text-sm">This entry is private.</div>
            {% endif %}
          {% else %}
            <div class="text-slate-500">No body text.</div>
          {% endif %}
        {% endif %}
      </div>

      <div class="px-6 py-4 border-t bg-white flex items-center gap-3">
        {% if not view_e.is_private_check() %}
        <form method="post" action="{{ url_for('make_private', entry_id=view_e.entry_id_str) }}"
              class="flex items-center gap-2">
          {% if not password_set %}
            <input name="password" type="password" class="rounded-xl border px-3 py-2"
                   placeholder="Create password" required />
            <button
              class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
              Set &amp; Make Private
            </button>
          {% else %}
            <button
              class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
              Make Private
            </button>
          {% endif %}
        </form>
        {% endif %}
        <a href="{{ url_for('edit_entry_open', entry_id=view_e.entry_id_str) }}"
           class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
          Edit
        </a>
        <form method="post" action="{{ url_for('delete_entry', entry_id=view_e.entry_id_str) }}"
              onsubmit="return confirm('Delete this entry?');" class="ml-auto">
          <button class="rounded-xl px-4 py-2 bg-slate-100 hover:bg-slate-200">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% if open_view_modal %}
<script>openModal('viewModal');</script>
{% endif %}
{% endif %}

<!-- Edit Entry Modal -->
{% if edit_e is defined %}
<div id="editModal" class="fixed inset-0 z-50 {% if not open_edit_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/40" onclick="closeModal('editModal')"></div>
  <div class="relative max-w-3xl mx-auto mt-10 w-[92%]">
    <div class="bg-white rounded-2xl shadow-xl max-h-[88vh] overflow-hidden flex flex-col">
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">Edit: {{ edit_e.entry_name }}</h3>
          <p class="text-sm text-slate-500">{{ edit_e.entry_date.isoformat() }}</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600" onclick="closeModal('editModal')">‚úï</button>
      </div>

      <div class="px-6 pb-6 space-y-8 overflow-y-auto">
        <!-- 1) Main edit form -->
        <section>
          <h4 class="font-semibold mb-3">Details</h4>
          <form method="post" action="{{ url_for('edit_entry_save', entry_id=edit_e.entry_id_str) }}"
                class="grid grid-cols-1 gap-4">
            <div>
              <label class="text-sm block mb-1">Title</label>
              <input name="title" value="{{ edit_e.entry_name }}" class="w-full rounded-xl border px-3 py-2" />
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="text-sm block mb-1">Year</label>
                <input name="year" type="number" value="{{ edit_e.entry_date.year }}"
                       class="w-full rounded-xl border px-3 py-2" />
              </div>
              <div>
                <label class="text-sm block mb-1">Month</label>
                <input name="month" type="number" value="{{ edit_e.entry_date.month }}"
                       class="w-full rounded-xl border px-3 py-2" />
              </div>
              <div>
                <label class="text-sm block mb-1">Day</label>
                <input name="day" type="number" value="{{ edit_e.entry_date.day }}"
                       class="w-full rounded-xl border px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm block mb-2">Ranking (1‚Äì8)</label>
              <div class="grid grid-cols-4 gap-2">
                {% for r in range(1,9) %}
                <label class="cursor-pointer flex items-center justify-center gap-2 rounded-xl border px-3 py-2 hover:bg-slate-50">
                  <input type="radio" name="ranking" value="{{ r }}" {% if r==edit_e.ranking %}checked{% endif %}
                         class="mr-2">
                  <span class="text-lg">{{ ranking_emoji(r) }}</span>
                  <span class="text-sm text-slate-700">{{ r }}</span>
                </label>
                {% endfor %}
              </div>
            </div>

            <div>
              <label class="text-sm block mb-1">Mood rating (1‚Äì100)</label>
              <input name="mood_rating" type="number" min="1" max="100"
                     value="{{ edit_e.mood_rating }}"
                     class="w-full rounded-xl border px-3 py-2" />
            </div>

            <div>
              <label class="text-sm block mb-1">Body</label>
              <textarea name="body" rows="6" class="w-full rounded-xl border px-3 py-2">
{{ edit_e.entry_body }}</textarea>
            </div>

            <div class="flex items-center justify-end">
              <button
                class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
                Save Changes
              </button>
            </div>
          </form>
        </section>

        <!-- 2) Biometrics form -->
        <section>
          <h4 class="font-semibold mb-3">Biometrics</h4>
          {% set current = edit_e.get_biometrics() if edit_e.get_biometrics else {} %}
          <form method="post" action="{{ url_for('edit_entry_save', entry_id=edit_e.entry_id_str) }}"
                class="grid grid-cols-1 gap-4">
            <div class="grid sm:grid-cols-2 gap-3">
              {% for key, choices in BIOMETRICS.items() %}
              <div>
                <div class="flex items-center justify-between mb-1">
                  <label class="text-xs text-slate-500">{{ key }}</label>
                  {% if current.get(key) %}
                  <form method="post" action="{{ url_for('clear_biometric', entry_id=edit_e.entry_id_str, key=key) }}">
                    <button class="text-xs text-rose-600 hover:underline" title="Clear">Clear</button>
                  </form>
                  {% endif %}
                </div>
                <select name="bio_{{ key }}" class="w-full rounded-xl border px-3 py-2">
                  <option value="">‚Äî</option>
                  {% for v in choices %}
                    <option value="{{ v }}" {% if current.get(key)==v %}selected{% endif %}>
                      {{ v|title }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              {% endfor %}
            </div>
            <p class="text-xs text-slate-500 mt-2">
              Leave a field as ‚Äú‚Äî‚Äù to keep it unchanged. Use ‚ÄúClear‚Äù to remove an existing value.
            </p>
            <div class="flex items-center justify-end">
              <button
                class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
                Save Biometrics
              </button>
            </div>
          </form>
        </section>

        <!-- 3) Tag Management -->
        <section>
          <h4 class="font-semibold mb-3">Tags</h4>

          {% if edit_e.tags %}
          <div class="flex flex-wrap gap-2 mb-3">
            {% for t in edit_e.tags %}
            <form method="post" action="{{ url_for('delete_tag', entry_id=edit_e.entry_id_str) }}" class="inline">
              <input type="hidden" name="tag" value="{{ t }}">
              <button class="inline-flex items-center gap-1 rounded-full bg-slate-100 text-slate-700 px-3 py-1 text-xs hover:bg-slate-200"
                      title="Remove tag">
                #{{ t }} <span aria-hidden="true">‚úï</span>
              </button>
            </form>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-sm text-slate-500 mb-3">No tags yet.</div>
          {% endif %}

          <form method="post" action="{{ url_for('add_tag', entry_id=edit_e.entry_id_str) }}"
                class="flex items-center gap-2">
            <input name="tag" class="flex-1 rounded-xl border px-3 py-2"
                   placeholder="Add a tag (e.g., study)" />
            <button class="rounded-xl px-3 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90">
              Add
            </button>
          </form>

          {% if edit_e.tags %}
          <form method="post" action="{{ url_for('clear_tags', entry_id=edit_e.entry_id_str) }}" class="mt-3">
            <button class="rounded-xl px-3 py-2 bg-slate-100 hover:bg-slate-200">
              Clear All Tags
            </button>
          </form>
          {% endif %}
        </section>
      </div>

      <div class="px-6 py-4 border-t bg-white flex items-center gap-3">
        <a href="{{ url_for('view_entry', entry_id=edit_e.entry_id_str) }}"
           class="rounded-xl px-4 py-2 bg-slate-100 hover:bg-slate-200">
          View
        </a>
        <button class="rounded-xl px-4 py-2 text-white bg-slate-900 hover:bg-slate-700 ml-auto"
                onclick="closeModal('editModal')">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% if open_edit_modal %}
<script>openModal('editModal');</script>
{% endif %}
{% endif %}

<!-- Report Modal (weekly/monthly) -->
{% if report is defined %}
<div id="reportModal" class="fixed inset-0 z-50 {% if not open_report_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/40" onclick="closeModal('reportModal')"></div>
  <div class="relative max-w-3xl mx-auto mt-10 w-[92%]">
    <div class="bg-white rounded-2xl shadow-xl max-h-[88vh] overflow-hidden flex flex-col">
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">{{ report.title }}</h3>
          <p class="text-sm text-slate-500">{{ report.start }} ‚Üí {{ report.end }}</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600" onclick="closeModal('reportModal')">‚úï</button>
      </div>

      <div class="px-6 pb-6 space-y-4 overflow-y-auto">
        <div class="text-sm text-slate-600">
          Total entries: <strong>{{ report.total }}</strong>
        </div>
        <div class="space-y-2">
          {% for bar in report.bars %}
          <div>
            <div class="flex items-center justify-between text-sm">
              <span>{{ bar.emoji }} Rank {{ bar.rank }}</span>
              <span class="text-slate-500">{{ bar.count }}</span>
            </div>
            <div class="w-full h-2 bg-slate-100 rounded-full mt-1">
              <div class="h-2 rounded-full bg-[rgb(var(--mj-accent))]" style="width: {{ bar.pct }}%"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="px-6 py-4 border-t bg-white flex items-center justify-end">
        <button class="rounded-xl px-4 py-2 text-white bg-[rgb(var(--mj-accent))] hover:bg-[rgb(var(--mj-accent))]/90"
                onclick="closeModal('reportModal')">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% if open_report_modal %}
<script>openModal('reportModal');</script>
{% endif %}
{% endif %}

{% endblock %}

{% block extra_scripts %}
{% if mood_graph_labels is defined and mood_graph_values is defined %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('moodChart');
  if (ctx) {
    const mode = "{{ mood_graph_mode }}";
    const labels = {{ mood_graph_labels | tojson }};
    const dataVals = {{ mood_graph_values | tojson }};

    const config = {
      type: mode === 'bar' ? 'bar' : 'line',
      data: {
        labels: labels,
        datasets: [{
          label: mode === 'bar' ? 'Rating frequency' : 'Average mood rating',
          data: dataVals,
          borderColor: 'rgb(99, 102, 241)',
          backgroundColor: 'rgba(99, 102, 241, 0.3)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: 100
          }
        }
      }
    };

    new Chart(ctx, config);
  }
</script>
{% endif %}
{% endblock %}
