{% extends "base.html" %}

{% block title %}Mood Journal ‚Ä¢ Demo{% endblock %}

{% block extra_head %}
<!-- Extra page-specific styles if needed -->
{% endblock %}

{% block content %}
<!-- Title -->
<div class="mb-8">
  <div class="flex items-center gap-4">
    <div class="p-3 rounded-xl text-white float-animation mj-accent-btn shadow-lg">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div>
      <h2 class="text-3xl font-bold text-slate-50">Mood Journal</h2>
      <p class="text-sm text-slate-300">
        Capture your day, track streaks, and visualize your emotional trends.
      </p>
    </div>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-8">
  <!-- Left: Streak, actions, calendar/mood graph preview -->
  <div class="mj-card rounded-xl shadow-sm border p-6">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <span class="text-xl">üî•</span>
        <h3 class="text-lg font-semibold text-slate-50">Streak</h3>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('weekly_report') }}"
           class="rounded-lg px-3 py-2 mj-accent-pill text-xs sm:text-sm border mj-accent-border">
          Weekly
        </a>
        <a href="{{ url_for('monthly_report') }}"
           class="rounded-lg px-3 py-2 mj-accent-pill text-xs sm:text-sm border mj-accent-border">
          Monthly
        </a>
        <button onclick="openModal('addModal')"
                class="rounded-lg px-3 py-2 mj-accent-btn text-xs sm:text-sm">
          + Add Entry
        </button>
      </div>
    </div>

    {% if summary is defined %}
      <div class="grid grid-cols-3 gap-4 text-center mt-6">
        <div class="mj-card-soft rounded-xl p-4 border">
          <div class="text-[11px] uppercase tracking-wide text-slate-400">Current</div>
          <div class="text-2xl font-bold mt-1 text-slate-50">{{ summary.current }}</div>
        </div>
        <div class="mj-card-soft rounded-xl p-4 border">
          <div class="text-[11px] uppercase tracking-wide text-slate-400">Longest</div>
          <div class="text-2xl font-bold mt-1 text-slate-50">{{ summary.longest }}</div>
        </div>
        <div class="mj-card-soft rounded-xl p-4 border">
          <div class="text-[11px] uppercase tracking-wide text-slate-400">Last Entry</div>
          <div class="text-sm font-medium mt-1 text-slate-50">
            {{ summary.last or "‚Äî" }}
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Calendar preview (stub list of dates with entries) -->
    {% if calendar is defined %}
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-semibold text-slate-100">Calendar overview</h4>
          <a href="{{ url_for('calendar_view') }}" class="text-xs text-slate-300 hover:text-slate-50 underline">
            Open calendar
          </a>
        </div>
        <p class="text-xs text-slate-400 mb-2">
          Dates with entries in the current month.
        </p>
        <div class="mj-card-soft border rounded-lg p-2 text-xs text-slate-200 max-h-40 overflow-y-auto">
          {% for d, entries_for_day in calendar.items() %}
            <div class="flex justify-between border-b border-slate-700/60 last:border-0 py-1">
              <span>{{ d }}</span>
              <span>{{ entries_for_day|length }} entr{{ 'ies' if entries_for_day|length != 1 else 'y' }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="mt-6 mj-card-soft border rounded-lg p-3 text-xs text-slate-300 flex items-center justify-between">
        <span>View your entries on a calendar grid.</span>
        <a href="{{ url_for('calendar_view') }}"
           class="mj-accent-btn px-2 py-1 rounded-lg text-[11px]">Open</a>
      </div>
    {% endif %}

    <!-- Mood graph preview -->
    {% if mood_graph_labels is defined and mood_graph_values is defined %}
      <script>
        window.moodGraphData = {
          labels: {{ mood_graph_labels|tojson }},
          values: {{ mood_graph_values|tojson }},
          mode: {{ (mood_graph_mode or 'line')|tojson }}
        };
      </script>

      <div class="mj-card-soft rounded-xl border mt-6 p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h4 class="text-sm font-semibold text-slate-100">Mood Graph</h4>
            <p class="text-xs text-slate-300">
              Last 14 days ¬∑ {{ (mood_graph_mode or 'line')|capitalize }} view
            </p>
          </div>
          <div class="flex items-center gap-1 text-xs">
            <a href="{{ url_for('mood_graph', mode='line') }}"
               class="px-2 py-1 rounded-lg border mj-accent-border
               {% if (mood_graph_mode or 'line') == 'line' %}
                 mj-accent-btn
               {% else %}
                 bg-transparent text-slate-200
               {% endif %}">
              Line
            </a>
            <a href="{{ url_for('mood_graph', mode='bar') }}"
               class="px-2 py-1 rounded-lg border mj-accent-border
               {% if (mood_graph_mode or 'line') == 'bar' %}
                 mj-accent-btn
               {% else %}
                 bg-transparent text-slate-200
               {% endif %}">
              Bar
            </a>
          </div>
        </div>
        <div class="h-48">
          <canvas id="moodChart"></canvas>
        </div>
      </div>
    {% else %}
      <div class="mj-card-soft rounded-xl border mt-6 p-4 text-xs text-slate-200">
        <div class="flex items-center justify-between">
          <span>Mood graph</span>
          <a href="{{ url_for('mood_graph', mode='line') }}"
             class="mj-accent-btn px-2 py-1 rounded-lg text-[11px]">
            Open
          </a>
        </div>
        <p class="mt-1 text-slate-300">
          Switch between line and bar views to explore your mood trends.
        </p>
      </div>
    {% endif %}
  </div>

  <!-- Right: Entries list -->
  <div class="mj-card rounded-xl shadow-sm border p-6">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-2">
        <span class="text-xl">üåô</span>
        <h3 class="text-lg font-semibold text-slate-50">Your Entries</h3>
      </div>
      {% if entries %}
        <span class="text-sm text-slate-300">
          {{ entries|length }} entr{{ 'ies' if entries|length != 1 else 'y' }}
        </span>
      {% endif %}
    </div>

    {% if entries %}
      <div class="space-y-3 max-h-[28rem] overflow-y-auto pr-1">
        {% for e in entries %}
        <div class="group relative p-4 rounded-xl border border-slate-800 bg-slate-900/60 hover:bg-slate-900/80 hover:shadow-md transition-all duration-200">
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-start gap-3">
              <div class="text-2xl leading-none" title="Ranking">
                {{ ranking_emoji(e.ranking) }}
              </div>
              <div>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-medium text-slate-50">{{ e.entry_name }}</span>
                  {% if e.is_private_check() %}
                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold mj-accent-badge">
                      üîí Private
                    </span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold bg-emerald-500/20 text-emerald-100 border border-emerald-500/60">
                      üåê Public
                    </span>
                  {% endif %}
                </div>
                <p class="text-[11px] text-slate-400 mt-0.5">
                  {{ e.entry_date.isoformat() }} ‚Ä¢ Mood rating: {{ e.mood_rating }}
                </p>

                {% set bios = e.get_biometrics() if e.get_biometrics else {} %}
                {% if bios %}
                  <div class="mt-2 flex flex-wrap gap-2">
                    {% for k, v in bios.items() %}
                      <span class="text-[11px] bg-amber-500/15 text-amber-100 border border-amber-400/60 rounded-full px-2 py-0.5">
                        {{ k }}: {{ v }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if e.tags %}
                  <div class="mt-2 flex flex-wrap gap-2">
                    {% for t in e.tags %}
                      <span class="text-[11px] bg-slate-800 text-slate-200 rounded-full px-2 py-0.5">
                        #{{ t }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="text-xs text-slate-500">
              {{ ranking_emoji(e.ranking) }} {{ e.ranking }}
            </div>
          </div>

          <div class="flex items-center gap-2 mt-2">
            <a href="{{ url_for('view_entry', entry_id=e.entry_id_str) }}"
               class="rounded-lg px-3 py-1.5 text-xs sm:text-sm bg-slate-100 text-slate-900 hover:bg-slate-200">
              View
            </a>

            <a href="{{ url_for('edit_entry_open', entry_id=e.entry_id_str) }}"
               class="rounded-lg px-3 py-1.5 text-xs sm:text-sm mj-accent-btn">
              Edit
            </a>

            <form method="post" action="{{ url_for('delete_entry', entry_id=e.entry_id_str) }}"
                  onsubmit="return confirm('Delete this entry?');">
              <button class="rounded-lg px-3 py-1.5 text-xs sm:text-sm bg-slate-800 text-slate-100 hover:bg-slate-700">
                Delete
              </button>
            </form>

            {% if not e.is_private_check() %}
              <form method="post" action="{{ url_for('make_private', entry_id=e.entry_id_str) }}" class="ml-auto">
                {% if not password_set %}
                  <button class="text-xs text-indigo-200 hover:underline">
                    Make Private (set password)
                  </button>
                {% else %}
                  <button class="text-xs text-indigo-200 hover:underline">
                    Make Private
                  </button>
                {% endif %}
              </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-900 rounded-full mb-4 border border-slate-700">
          <span class="text-2xl">‚òÅÔ∏è</span>
        </div>
        <p class="text-slate-300 text-sm">
          No entries yet. Click ‚ÄúAdd Entry‚Äù to start your journal.
        </p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Tag Organizer   -->

<div class="mt-10 mj-card rounded-xl shadow-sm border p-6">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h3 class="text-sm font-semibold text-slate-50">Tag Organizer</h3>
      <p class="text-xs text-slate-400 mt-1">
        See what you write about most and quickly jump to entries by tag.
      </p>
    </div>
    <div class="flex gap-2 text-[11px]">
      <a href="{{ url_for('index', show='tags') }}"
         class="rounded-lg px-2 py-1 bg-slate-900 text-slate-100 border border-slate-700 hover:bg-slate-800">
        Refresh tags
      </a>
      <a href="{{ url_for('index', show='tag-summary') }}"
         class="rounded-lg px-2 py-1 bg-slate-900 text-slate-100 border border-slate-700 hover:bg-slate-800">
        Refresh summary
      </a>
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-6 text-xs sm:text-sm">
    <!-- Column 1: All tags -->
    <section>
      <h4 class="font-semibold text-slate-100 mb-2">All tags</h4>
      {% if all_tags is defined and all_tags %}
        <div class="flex flex-wrap gap-2">
          {% for t in all_tags %}
            <a href="{{ url_for('index', tag=t) }}"
               class="inline-flex items-center rounded-full bg-slate-900 text-slate-200 px-3 py-1 border border-slate-700 hover:bg-slate-800">
              #{{ t }}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">
          No tags yet. Add tags to entries to organize them by theme.
        </p>
      {% endif %}
    </section>

    <!-- Column 2: Tag usage summary -->
    <section>
      <h4 class="font-semibold text-slate-100 mb-2">Most used tags</h4>
      {% if tag_summary is defined and tag_summary %}
        <div class="space-y-1">
          {% for t, count in tag_summary %}
          <div class="flex items-center justify-between">
            <a href="{{ url_for('index', tag=t) }}"
               class="text-slate-100 hover:underline">#{{ t }}</a>
            <span class="text-slate-400">{{ count }} entr{{ 'ies' if count != 1 else 'y' }}</span>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">
          Tag usage summary will appear here after you refresh it and have tagged entries.
        </p>
      {% endif %}
    </section>

    <!-- Column 3: Search entries by tag -->
    <section>
      <h4 class="font-semibold text-slate-100 mb-2">Entries for a tag</h4>
      <form method="get" action="{{ url_for('index') }}" class="flex flex-col gap-2 mb-3">
        <div class="flex gap-2 items-center">
          <input name="tag"
       value="{{ selected_tag or '' }}"
       class="flex-1 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50 text-xs sm:text-sm"
       placeholder="e.g., work, gym, study" />
          <button class="rounded-xl px-3 py-2 mj-accent-btn text-xs sm:text-sm">
            Filter
          </button>
        </div>
        <p class="text-[11px] text-slate-400">
          Matching is case-insensitive and ignores extra spaces.
        </p>
      </form>

      {% if tag_entries is defined %}
        {% if tag_entries %}
          <p class="text-[11px] text-slate-300 mb-2">
            Showing entries tagged <span class="font-semibold">#{{ selected_tag }}</span>:
          </p>
          <ul class="space-y-1 max-h-32 overflow-y-auto">
            {% for e in tag_entries %}
              <li class="flex items-center justify-between">
                <a href="{{ url_for('view_entry', entry_id=e.entry_id_str) }}"
                   class="text-slate-100 hover:underline">
                  {{ e.entry_name }}
                </a>
                <span class="text-[11px] text-slate-500">
                  {{ e.entry_date.isoformat() }}
                </span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-[11px] text-slate-400">
            No entries found for that tag.
          </p>
        {% endif %}
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Entry Modal -->
<div id="addModal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/60" onclick="closeModal('addModal')"></div>
  <div class="relative max-w-xl mx-auto mt-16 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[85vh] flex flex-col border">
      <!-- Header -->
      <div class="px-6 pt-6 pb-4 flex items-start justify-between">
        <h3 class="text-lg font-semibold text-slate-50">Add Entry</h3>
        <button class="text-slate-400 hover:text-slate-200" onclick="closeModal('addModal')">‚úï</button>
      </div>

      <!-- Body -->
      <div class="px-6 pb-4 overflow-y-auto">
        <form id="addForm" method="POST" action="{{ url_for('add_entry') }}" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-100 mb-1">Title</label>
            <input name="title"
                   class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                   required />
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-sm block mb-1 text-slate-100">Year</label>
              <input name="year" type="number"
                     class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                     value="{{ today.year }}" required />
            </div>
            <div>
              <label class="text-sm block mb-1 text-slate-100">Month</label>
              <input name="month" type="number"
                     class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                     value="{{ today.month }}" required />
            </div>
            <div>
              <label class="text-sm block mb-1 text-slate-100">Day</label>
              <input name="day" type="number"
                     class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                     value="{{ today.day }}" required />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-100 mb-2">Ranking (1‚Äì8)</label>
            <div class="grid grid-cols-4 gap-2">
              {% for r in range(1,9) %}
                <label class="cursor-pointer flex items-center justify-center gap-2 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 hover:bg-slate-800 text-slate-100">
                  <input type="radio" name="ranking" value="{{ r }}" {% if r==5 %}checked{% endif %}
                         class="mr-1 accent-indigo-500">
                  <span class="text-lg">{{ ranking_emoji(r) }}</span>
                  <span class="text-sm text-slate-200">{{ r }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-100 mb-1">
              Mood rating (1‚Äì100)
            </label>
            <input name="mood_rating" type="number" min="1" max="100"
                   value="50"
                   class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
            <p class="text-[11px] text-slate-400 mt-1">
              Use this for the mood graph; 1 = worst, 100 = best.
            </p>
          </div>

          <!-- Biometrics (Add) -->
          <div>
            <label class="block text-sm font-medium text-slate-100 mb-2">Biometrics (optional)</label>
            <div class="grid sm:grid-cols-2 gap-3">
              {% for key, choices in BIOMETRICS.items() %}
              <div>
                <label class="text-[11px] text-slate-400 block mb-1">{{ key }}</label>
                <select name="bio_{{ key }}"
                        class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50 text-sm">
                  <option value="">‚Äî</option>
                  {% for v in choices %}
                    <option value="{{ v }}">{{ v|title }}</option>
                  {% endfor %}
                </select>
              </div>
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="text-sm block mb-1 text-slate-100">Tags (comma-separated)</label>
            <input name="tags"
                   class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                   placeholder="work, gym, study" />
          </div>

          <div>
            <label class="text-sm block mb-1 text-slate-100">Body</label>
            <textarea name="body" rows="6"
                      class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                      placeholder="How was your day?"></textarea>
          </div>
        </form>
      </div>

      <!-- Sticky footer -->
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 rounded-b-2xl flex items-center justify-end gap-3">
        <button type="button"
                onclick="closeModal('addModal')"
                class="rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-100">
          Cancel
        </button>
        <button type="submit" form="addForm"
                class="rounded-xl px-4 py-2 mj-accent-btn">
          Create
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Entry Modal -->
{% if view_e is defined %}
<div id="viewModal" class="fixed inset-0 z-50 {% if not open_view_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/60" onclick="closeModal('viewModal')"></div>
  <div class="relative max-w-2xl mx-auto mt-12 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[85vh] overflow-hidden flex flex-col border">
      <!-- Header -->
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold text-slate-50">{{ view_e.entry_name }}</h3>
          <p class="text-sm text-slate-400">{{ view_e.entry_date.isoformat() }}</p>
        </div>
        <button class="text-slate-400 hover:text-slate-200" onclick="closeModal('viewModal')">‚úï</button>
      </div>

      <div class="px-6 pb-4">
        <div class="text-slate-200 flex items-center gap-4 text-sm">
          <div>
            <span class="text-xs text-slate-400">Ranking:</span>
            <span class="font-semibold ml-1">
              {{ ranking_emoji(view_e.ranking) }} {{ view_e.ranking }}
            </span>
          </div>
          <div>
            <span class="text-xs text-slate-400">Mood rating:</span>
            <span class="font-semibold ml-1">{{ view_e.mood_rating }}</span>
          </div>
          {% if view_e.is_private_check() %}
            <span class="inline-flex items-center rounded-full bg-rose-500/20 text-rose-100 text-[11px] font-semibold px-2 py-0.5">
              üîí Private
            </span>
          {% else %}
            <span class="inline-flex items-center rounded-full bg-emerald-500/20 text-emerald-100 text-[11px] font-semibold px-2 py-0.5">
              üåê Public
            </span>
          {% endif %}
        </div>

        <!-- Biometrics (View) -->
        {% set bios = view_e.get_biometrics() if view_e.get_biometrics else {} %}
        {% if bios %}
          <div class="mt-3 flex flex-wrap gap-2">
            {% for k, v in bios.items() %}
              <span class="text-[11px] bg-amber-500/15 text-amber-100 border border-amber-400/60 rounded-full px-2 py-0.5">
                {{ k }}: {{ v }}
              </span>
            {% endfor %}
          </div>
        {% endif %}

        {% if view_e.tags %}
          <div class="mt-3 flex flex-wrap gap-2">
            {% for t in view_e.tags %}
              <span class="text-[11px] bg-slate-800 text-slate-200 rounded-full px-2 py-1">
                #{{ t }}
              </span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Body / Unlock -->
      <div class="px-6 pb-6 overflow-y-auto text-sm text-slate-100">
        {% if view_body is not none %}
          <div class="whitespace-pre-wrap">{{ view_body|safe }}</div>
        {% else %}
          {% if view_e.is_private_check() %}
            {% if view_ask_password %}
              <form method="post" action="{{ url_for('unlock_entry', entry_id=view_e.entry_id_str) }}"
                    class="space-y-3 max-w-sm">
                <p class="text-sm text-slate-200">
                  This entry is private. Enter the password to view.
                </p>
                <input name="password" type="password"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                       placeholder="Password" required />
                <button class="rounded-xl px-4 py-2 mj-accent-btn">
                  Unlock
                </button>
              </form>
            {% else %}
              <div class="text-slate-400 text-sm">This entry is private.</div>
            {% endif %}
          {% else %}
            <div class="text-slate-400">No body text.</div>
          {% endif %}
        {% endif %}
      </div>

      <!-- Footer actions -->
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 flex items-center gap-3">
        {% if not view_e.is_private_check() %}
          <form method="post" action="{{ url_for('make_private', entry_id=view_e.entry_id_str) }}"
                class="flex items-center gap-2 text-sm">
            {% if not password_set %}
              <input name="password" type="password"
                     class="rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50"
                     placeholder="Create password" required />
              <button class="rounded-xl px-4 py-2 mj-accent-btn">
                Set &amp; Make Private
              </button>
            {% else %}
              <button class="rounded-xl px-4 py-2 mj-accent-btn">
                Make Private
              </button>
            {% endif %}
          </form>
        {% endif %}
        <a href="{{ url_for('edit_entry_open', entry_id=view_e.entry_id_str) }}"
           class="rounded-xl px-4 py-2 bg-slate-800 text-slate-100 hover:bg-slate-700 text-sm">
          Edit
        </a>
        <form method="post" action="{{ url_for('delete_entry', entry_id=view_e.entry_id_str) }}"
              onsubmit="return confirm('Delete this entry?');" class="ml-auto">
          <button class="rounded-xl px-4 py-2 bg-slate-900 text-slate-100 hover:bg-slate-800 text-sm">
            Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% if open_view_modal %}
<script>openModal('viewModal');</script>
{% endif %}
{% endif %}

<!-- Edit Entry Modal -->
{% if edit_e is defined %}
<div id="editModal" class="fixed inset-0 z-50 {% if not open_edit_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/60" onclick="closeModal('editModal')"></div>
  <div class="relative max-w-3xl mx-auto mt-10 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[88vh] overflow-hidden flex flex-col border">
      <!-- Header -->
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold text-slate-50">Edit: {{ edit_e.entry_name }}</h3>
          <p class="text-sm text-slate-400">{{ edit_e.entry_date.isoformat() }}</p>
        </div>
        <button class="text-slate-400 hover:text-slate-200" onclick="closeModal('editModal')">‚úï</button>
      </div>

      <div class="px-6 pb-6 space-y-8 overflow-y-auto text-sm">
        <!-- 1) Main edit form -->
        <section>
          <h4 class="font-semibold mb-3 text-slate-100">Details</h4>
          <form method="post" action="{{ url_for('edit_entry_save', entry_id=edit_e.entry_id_str) }}"
                class="grid grid-cols-1 gap-4">
            <div>
              <label class="text-sm block mb-1 text-slate-100">Title</label>
              <input name="title" value="{{ edit_e.entry_name }}"
                     class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="text-sm block mb-1 text-slate-100">Year</label>
                <input name="year" type="number" value="{{ edit_e.entry_date.year }}"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
              </div>
              <div>
                <label class="text-sm block mb-1 text-slate-100">Month</label>
                <input name="month" type="number" value="{{ edit_e.entry_date.month }}"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
              </div>
              <div>
                <label class="text-sm block mb-1 text-slate-100">Day</label>
                <input name="day" type="number" value="{{ edit_e.entry_date.day }}"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
              </div>
            </div>

            <div>
              <label class="text-sm block mb-2 text-slate-100">Ranking (1‚Äì8)</label>
              <div class="grid grid-cols-4 gap-2">
                {% for r in range(1,9) %}
                  <label class="cursor-pointer flex items-center justify-center gap-2 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 hover:bg-slate-800 text-slate-100">
                    <input type="radio" name="ranking" value="{{ r }}"
                           {% if r==edit_e.ranking %}checked{% endif %}
                           class="mr-1 accent-indigo-500">
                    <span class="text-lg">{{ ranking_emoji(r) }}</span>
                    <span class="text-sm text-slate-200">{{ r }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>

            <div>
              <label class="text-sm block mb-1 text-slate-100">Mood rating (1‚Äì100)</label>
              <input name="mood_rating" type="number" min="1" max="100"
                     value="{{ edit_e.mood_rating }}"
                     class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50" />
            </div>

            <div>
              <label class="text-sm block mb-1 text-slate-100">Body</label>
              <textarea name="body" rows="6"
                        class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50">{{ edit_e.entry_body }}</textarea>
            </div>

            <div class="flex items-center justify-end">
              <button class="rounded-xl px-4 py-2 mj-accent-btn">
                Save Changes
              </button>
            </div>
          </form>
        </section>

        <!-- 2) Biometrics form -->
        <section>
          <h4 class="font-semibold mb-3 text-slate-100">Biometrics</h4>
          {% set current = edit_e.get_biometrics() if edit_e.get_biometrics else {} %}
          <form method="post" action="{{ url_for('edit_entry_save', entry_id=edit_e.entry_id_str) }}"
                class="grid grid-cols-1 gap-4">
            <div class="grid sm:grid-cols-2 gap-3">
              {% for key, choices in BIOMETRICS.items() %}
                <div>
                  <label class="text-[11px] text-slate-400 block mb-1">{{ key }}</label>
                  <select name="bio_{{ key }}"
                          class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50 text-sm">
                    <option value="">‚Äî</option>
                    {% for v in choices %}
                      <option value="{{ v }}" {% if current.get(key)==v %}selected{% endif %}>
                        {{ v|title }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}
            </div>
            <div class="flex items-center justify-end">
              <button class="rounded-xl px-4 py-2 mj-accent-btn">
                Save Biometrics
              </button>
            </div>
          </form>

          {% if current %}
          <div class="mt-3 flex flex-wrap gap-2">
            {% for key, val in current.items() %}
              <form method="post"
                    action="{{ url_for('clear_biometric', entry_id=edit_e.entry_id_str, key=key) }}">
                <button class="text-[11px] text-rose-300 hover:underline" title="Clear {{ key }}">
                  Clear {{ key }}
                </button>
              </form>
            {% endfor %}
          </div>
          {% endif %}
        </section>

        <!-- 3) Tag Management -->
        <section>
          <h4 class="font-semibold mb-3 text-slate-100">Tags</h4>

          {% if edit_e.tags %}
            <div class="flex flex-wrap gap-2 mb-3">
              {% for t in edit_e.tags %}
                <form method="post"
                      action="{{ url_for('delete_tag', entry_id=edit_e.entry_id_str) }}"
                      class="inline">
                  <input type="hidden" name="tag" value="{{ t }}">
                  <button class="inline-flex items-center gap-1 rounded-full bg-slate-800 text-slate-200 px-3 py-1 text-[11px] hover:bg-slate-700"
                          title="Remove tag">
                    #{{ t }} <span aria-hidden="true">‚úï</span>
                  </button>
                </form>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-slate-400 mb-3">No tags yet.</div>
          {% endif %}

          <form method="post" action="{{ url_for('add_tag', entry_id=edit_e.entry_id_str) }}"
                class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
            <input name="tag"
                   class="flex-1 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-slate-50 text-sm"
                   placeholder="Add a tag (e.g., study)" />
            <button class="rounded-xl px-3 py-2 mj-accent-btn text-sm">
              Add
            </button>
          </form>

          {% if edit_e.tags %}
            <form method="post" action="{{ url_for('clear_tags', entry_id=edit_e.entry_id_str) }}"
                  class="mt-3">
              <button class="rounded-xl px-3 py-2 bg-slate-800 text-slate-100 hover:bg-slate-700 text-sm">
                Clear All Tags
              </button>
            </form>
          {% endif %}
        </section>
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 flex items-center gap-3">
        <a href="{{ url_for('view_entry', entry_id=edit_e.entry_id_str) }}"
           class="rounded-xl px-4 py-2 bg-slate-800 text-slate-100 hover:bg-slate-700 text-sm">
          View
        </a>
        <button class="rounded-xl px-4 py-2 bg-slate-900 text-slate-100 hover:bg-slate-800 ml-auto text-sm"
                onclick="closeModal('editModal')">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% if open_edit_modal %}
<script>openModal('editModal');</script>
{% endif %}
{% endif %}

<!-- Report Modal (weekly/monthly) -->
{% if report is defined %}
<div id="reportModal" class="fixed inset-0 z-50 {% if not open_report_modal %}hidden{% endif %}">
  <div class="absolute inset-0 bg-black/60" onclick="closeModal('reportModal')"></div>
  <div class="relative max-w-3xl mx-auto mt-10 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[88vh] overflow-hidden flex flex-col border">
      <div class="px-6 pt-6 pb-3 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold text-slate-50">{{ report.title }}</h3>
          <p class="text-sm text-slate-400">
            {{ report.start }} ‚Üí {{ report.end }}
          </p>
        </div>
        <button class="text-slate-400 hover:text-slate-200"
                onclick="closeModal('reportModal')">‚úï</button>
      </div>

      <div class="px-6 pb-6 space-y-4 overflow-y-auto text-sm text-slate-100">
        <div>Total entries: <strong>{{ report.total }}</strong></div>
        <div class="space-y-2">
          {% for bar in report.bars %}
          <div>
            <div class="flex items-center justify-between text-xs sm:text-sm">
              <span>{{ bar.emoji }} Rank {{ bar.rank }}</span>
              <span class="text-slate-300">{{ bar.count }}</span>
            </div>
            <div class="w-full h-2 bg-slate-800 rounded-full mt-1 overflow-hidden">
              <div class="h-2 mj-accent-btn rounded-full" style="width: {{ bar.pct }}%"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 flex items-center justify-end">
        <button class="rounded-xl px-4 py-2 bg-slate-900 text-slate-100 hover:bg-slate-800 text-sm"
                onclick="closeModal('reportModal')">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% if open_report_modal %}
<script>openModal('reportModal');</script>
{% endif %}
{% endif %}

<!-- Emoji Groups Overview Modal -->
<dialog id="emojiGroupsModal" class="modal" {% if open_emoji_groups_modal %}open{% endif %}>
  <div class="absolute inset-0 bg-black/60" onclick="emojiGroupsModal.close()"></div>
  <div class="relative max-w-4xl mx-auto mt-16 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[85vh] flex flex-col border">
      <!-- Header -->
      <div class="px-6 pt-6 pb-4 flex items-start justify-between">
        <h3 class="text-lg font-semibold text-slate-50">Emoji Groups Analysis</h3>
        <button class="text-slate-400 hover:text-slate-200" onclick="emojiGroupsModal.close()">‚úï</button>
      </div>

      <!-- Body -->
      <div class="px-6 pb-6 overflow-y-auto">
        {% if emoji_groups_data %}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for rank in range(1, 6) %}
              {% if rank in emoji_groups_data %}
                {% set group = emoji_groups_data[rank] %}
                <div class="mj-card-soft rounded-xl p-4 border border-slate-700">
                  <div class="text-center mb-4">
                    <span class="text-4xl">{{ group.emoji }}</span>
                    <h4 class="text-sm font-semibold text-slate-100 mt-2">{{ group.total_entries }} entries</h4>
                  </div>
                  
                  {% if group.distribution %}
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                      {% for item in group.distribution %}
                        <div class="flex items-center justify-between text-xs">
                          <span class="text-slate-300">Rating {{ item.rating }}</span>
                          <div class="flex items-center gap-2">
                            <div class="w-16 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div class="h-full mj-accent-btn rounded-full" style="width: {{ item.pct }}%"></div>
                            </div>
                            <span class="text-slate-400 text-xs w-12 text-right">{{ item.count }} ({{ item.pct }}%)</span>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-xs text-slate-400 text-center">No mood rating data</p>
                  {% endif %}
                  
                  <div class="mt-4 text-center">
                    <a href="{{ url_for('emoji_group_detail', emoji_rank=rank) }}" 
                       class="inline-block rounded-xl px-3 py-2 mj-accent-btn text-xs">
                      View All Entries
                    </a>
                  </div>
                </div>
              {% else %}
                <div class="mj-card-soft rounded-xl p-4 border border-slate-700 opacity-50 text-center">
                  <span class="text-4xl">{{ ranking_emoji(rank) }}</span>
                  <h4 class="text-sm font-semibold text-slate-100 mt-2">0 entries</h4>
                  <p class="text-xs text-slate-400 mt-2">No entries with this emoji</p>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-8">
            <p class="text-slate-400">No emoji group data available.</p>
          </div>
        {% endif %}
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 flex items-center justify-end">
        <button class="rounded-xl px-4 py-2 bg-slate-900 text-slate-100 hover:bg-slate-800 text-sm"
                onclick="emojiGroupsModal.close()">
          Close
        </button>
      </div>
    </div>
  </div>
</dialog>

<!-- Emoji Group Detail Modal -->
<dialog id="emojiGroupDetailModal" class="modal" {% if open_emoji_group_detail_modal %}open{% endif %}>
  <div class="absolute inset-0 bg-black/60" onclick="emojiGroupDetailModal.close()"></div>
  <div class="relative max-w-4xl mx-auto mt-16 w-[92%]">
    <div class="mj-card rounded-2xl shadow-xl max-h-[85vh] flex flex-col border">
      <!-- Header -->
      <div class="px-6 pt-6 pb-4 flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold text-slate-50">
            <span class="text-2xl mr-2">{{ emoji_group_detail.emoji if emoji_group_detail }}</span>
            Emoji Group Details
          </h3>
          {% if emoji_group_detail %}
            <p class="text-sm text-slate-400">{{ emoji_group_detail.total_entries }} total entries</p>
          {% endif %}
        </div>
        <button class="text-slate-400 hover:text-slate-200" onclick="emojiGroupDetailModal.close()">‚úï</button>
      </div>

      <!-- Body -->
      <div class="px-6 pb-6 overflow-y-auto">
        {% if emoji_group_detail %}
          <!-- Distribution Section -->
          <div class="mb-6">
            <h4 class="font-semibold text-slate-100 mb-3">Mood Rating Distribution</h4>
            <div class="space-y-2 max-h-60 overflow-y-auto">
              {% for item in emoji_group_detail.distribution %}
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-300 w-20">Rating {{ item.rating }}</span>
                  <div class="flex-1 mx-3">
                    <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                      <div class="h-full mj-accent-btn rounded-full" style="width: {{ item.pct }}%"></div>
                    </div>
                  </div>
                  <span class="text-xs text-slate-400 w-16 text-right">{{ item.count }} ({{ item.pct }}%)</span>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Entries List -->
          <div>
            <h4 class="font-semibold text-slate-100 mb-3">All Entries</h4>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              {% for entry in emoji_group_detail.emoji_entries %}
                <div class="mj-card-soft rounded-xl p-4 border border-slate-700">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-start gap-3">
                      <span class="text-2xl">{{ entry.determine_ranking_emoji() }}</span>
                      <div>
                        <h5 class="font-medium text-slate-50">{{ entry.entry_name }}</h5>
                        <p class="text-xs text-slate-400">{{ entry.entry_date.strftime('%B %d, %Y') }}</p>
                        <p class="text-xs text-slate-400 mt-1">Mood rating: {{ entry.mood_rating }}</p>
                        
                        {% if entry.tags %}
                          <div class="mt-2 flex flex-wrap gap-1">
                            {% for tag in entry.tags %}
                              <span class="text-[10px] bg-slate-800 text-slate-200 rounded-full px-2 py-0.5">
                                #{{ tag }}
                              </span>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <a href="{{ url_for('view_entry', entry_id=entry.entry_id_str) }}"
                       class="rounded-lg px-3 py-1 text-xs bg-slate-100 text-slate-900 hover:bg-slate-200">
                      View
                    </a>
                    <a href="{{ url_for('edit_entry_open', entry_id=entry.entry_id_str) }}"
                       class="rounded-lg px-3 py-1 text-xs mj-accent-btn">
                      Edit
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="text-center py-8">
            <p class="text-slate-400">No emoji group detail data available.</p>
          </div>
        {% endif %}
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-slate-800 bg-slate-950/80 flex items-center justify-between">
        <a href="{{ url_for('emoji_groups') }}"
           class="rounded-xl px-4 py-2 bg-slate-800 text-slate-100 hover:bg-slate-700 text-sm">
          Back to All Groups
        </a>
        <button class="rounded-xl px-4 py-2 bg-slate-900 text-slate-100 hover:bg-slate-800 text-sm"
                onclick="emojiGroupDetailModal.close()">
          Close
        </button>
      </div>
    </div>
  </div>
</dialog>

{% endblock %}

{% block extra_scripts %}
  {% if mood_graph_labels is defined and mood_graph_values is defined %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function () {
        if (!window.moodGraphData) return;

        const ctx = document.getElementById('moodChart');
        if (!ctx) return;

        const rawLabels = window.moodGraphData.labels || [];
        const rawValues = window.moodGraphData.values || [];
        const mode = window.moodGraphData.mode || 'line';

        let labels = [];
        let data = [];

        if (mode === 'bar') {
          // Only show bars for ratings that actually occur
          for (let i = 0; i < rawLabels.length; i++) {
            if (rawValues[i] > 0) {
              labels.push(rawLabels[i]);
              data.push(rawValues[i]);
            }
          }
        } else {
          // Line: all dates, clamp y to [0, 100]
          labels = rawLabels;
          data = rawValues.map(v => {
            if (v === null || v === undefined) return 0;
            return Math.max(0, Math.min(100, v));
          });
        }

        const chartType = mode === 'bar' ? 'bar' : 'line';

        const accent = getComputedStyle(document.documentElement)
          .getPropertyValue('--mj-accent').trim();
        const accentSoft = getComputedStyle(document.documentElement)
          .getPropertyValue('--mj-accent-soft').trim();

        const chartConfig = {
          type: chartType,
          data: {
            labels: labels,
            datasets: [{
              label: mode === 'bar'
                ? 'Mood rating frequency'
                : 'Average mood rating (1‚Äì100)',
              data: data,
              borderWidth: 2,
              borderColor: `rgb(${accent})`,
              backgroundColor: mode === 'bar'
                ? `rgba(${accentSoft}, 0.8)`
                : `rgba(${accentSoft}, 0.3)`,
              tension: mode === 'line' ? 0.25 : 0,
              fill: mode === 'line'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: mode === 'bar' ? 15 : 10,
                  color: '#cbd5f5'
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.2)'
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(148, 163, 184, 0.2)'
                },
                ticks: {
                  stepSize: mode === 'bar' ? 1 : 10,
                  color: '#cbd5f5'
                },
                min: mode === 'line' ? 0 : undefined,
                max: mode === 'line' ? 100 : undefined
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    if (mode === 'bar') {
                      return `Count: ${ctx.parsed.y}`;
                    }
                    return `Mood: ${ctx.parsed.y}`;
                  }
                }
              }
            }
          }
        };

        new Chart(ctx, chartConfig);
      })();
    </script>
  {% endif %}

  <!-- Auto-open emoji groups modals -->
  <script>
document.addEventListener('DOMContentLoaded', function() {
  {% if open_emoji_groups_modal %}
    console.log('Opening emoji groups modal');
    const emojiGroupsModal = document.getElementById('emojiGroupsModal');
    if (emojiGroupsModal) {
      emojiGroupsModal.showModal();
    }
  {% endif %}
  
  {% if open_emoji_group_detail_modal %}
    console.log('Opening emoji group detail modal');
    const emojiGroupDetailModal = document.getElementById('emojiGroupDetailModal');
    if (emojiGroupDetailModal) {
      emojiGroupDetailModal.showModal();
    }
  {% endif %}
});
  </script>

{% endblock %}
